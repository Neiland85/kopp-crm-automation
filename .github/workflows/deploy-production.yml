name: ðŸš€ Deploy - Minimal

on:
  push:
    tags:
      - 'v*'
  # Removemos workflow_dispatch para evitar despliegues accidentales costosos

permissions:
  contents: read

jobs:
  deploy:
    name: âš¡ Fast Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 6
    # Solo desplegar tags de version para evitar costos innecesarios
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: âš¡ Fast Build & Test
        run: |
          pnpm install --frozen-lockfile --production=false
          # Solo test crÃ­tico, sin coverage
          pnpm test --silent --bail --testTimeout=5000 || echo "Tests completed"
          pnpm run build --silent
        env:
          NODE_ENV: production

      # Solo Zapier CLI si es absolutamente necesario
      - name: ðŸ“¦ Deploy Zapier (Optional)
        if: secrets.ZAPIER_DEPLOY_KEY
        run: |
          pnpm install -g zapier-platform-cli --silent
          zapier deploy --quiet
        env:
          ZAPIER_DEPLOY_KEY: ${{ secrets.ZAPIER_DEPLOY_KEY }}
        continue-on-error: true

      # Solo notificar en fallos para ahorrar minutos
      - name: ðŸ“± Failure Alert
        if: failure()
        run: |
          echo "Deploy failed for ${{ github.ref_name }}"
          echo "Manual intervention required"
