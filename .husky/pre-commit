# Hook pre-commit para Kopp CRM
# Se ejecuta autom√°ticamente antes de cada commit

set -e

echo "üîç Ejecutando validaciones pre-commit..."

# 1. Ejecutar lint-staged (formato y lint de archivos staged)
echo "üìù Formateando y validando archivos staged..."
npx lint-staged

# 2. Ejecutar validaci√≥n local r√°pida
echo "‚ö° Ejecutando validaci√≥n local..."
npm run validate:local

# 3. Validar que no hay secrets en el c√≥digo
echo "üîê Verificando que no hay secrets expuestos..."
if grep -r "sk-" src/ --include="*.ts" --include="*.js" 2>/dev/null; then
    echo "‚ùå Error: Posible API key expuesta en el c√≥digo"
    exit 1
fi

if grep -r "xoxb-" src/ --include="*.ts" --include="*.js" 2>/dev/null; then
    echo "‚ùå Error: Posible token de Slack expuesto en el c√≥digo"
    exit 1
fi

# 4. Verificar que .env no est√° en staging
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo "‚ùå Error: No commitear archivo .env"
    exit 1
fi

echo "‚úÖ Todas las validaciones pre-commit pasaron exitosamente"
