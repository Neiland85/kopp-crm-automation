{"file":"/Users/estudio/Projects/GitHub/MICROSERVICIOS/kopp-stadium-crm_slack-hubspot-zappier-notion/kopp-crm-automation/src/routes/zapier.ts","mappings":"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","names":[],"sources":["/Users/estudio/Projects/GitHub/MICROSERVICIOS/kopp-stadium-crm_slack-hubspot-zappier-notion/kopp-crm-automation/src/routes/zapier.ts"],"sourcesContent":["import express from 'express';\nimport { Request, Response } from 'express';\n\nconst router = express.Router();\n\n/**\n * @swagger\n * /zapier/webhook/lead-scoring:\n *   post:\n *     tags: [Zapier]\n *     summary: Webhook para lead scoring desde Google Sheets\n *     description: |\n *       Recibe webhooks de Zapier cuando se actualiza el lead scoring en Google Sheets.\n *\n *       **Flujo de automatización:**\n *       1. 📊 Google Sheets calcula nuevo score de lead\n *       2. ⚡ Zapier dispara webhook a este endpoint\n *       3. 🔄 Sistema actualiza score en HubSpot\n *       4. 🔔 Notificación automática a Slack si score > 70\n *       5. 📈 Actualización en dashboard de reporting\n *\n *       **Validaciones incluidas:**\n *       - ✅ Verificación de firma de Zapier\n *       - 📊 Validación de formato de scoring\n *       - 🔒 Verificación de contacto existente\n *       - 🚫 Prevención de actualizaciones duplicadas\n *     security:\n *       - apiKeyAuth: []\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required: [contact_id, score, source]\n *             properties:\n *               contact_id:\n *                 type: string\n *                 description: ID del contacto en HubSpot\n *                 example: \"12345678901\"\n *               email:\n *                 type: string\n *                 format: email\n *                 description: Email del contacto (fallback si no hay contact_id)\n *                 example: \"juan.perez@acme.com\"\n *               score:\n *                 type: integer\n *                 minimum: 0\n *                 maximum: 100\n *                 description: Nuevo score calculado\n *                 example: 85\n *               source:\n *                 type: string\n *                 description: Fuente del scoring\n *                 example: \"google_sheets_automation\"\n *               scoring_factors:\n *                 type: object\n *                 description: Factores que contribuyeron al score\n *                 properties:\n *                   demographic:\n *                     type: integer\n *                     description: Puntuación demográfica\n *                   behavioral:\n *                     type: integer\n *                     description: Puntuación comportamental\n *                   engagement:\n *                     type: integer\n *                     description: Puntuación de engagement\n *                   company_fit:\n *                     type: integer\n *                     description: Puntuación de fit de empresa\n *               metadata:\n *                 type: object\n *                 description: Metadatos adicionales del scoring\n *                 properties:\n *                   sheet_row:\n *                     type: integer\n *                     description: Fila en Google Sheets\n *                   calculation_timestamp:\n *                     type: string\n *                     format: date-time\n *                     description: Timestamp del cálculo en Sheets\n *           examples:\n *             high_score_lead:\n *               summary: Lead con score alto\n *               value:\n *                 contact_id: \"12345678901\"\n *                 email: \"juan.perez@acme.com\"\n *                 score: 90\n *                 source: \"google_sheets_automation\"\n *                 scoring_factors:\n *                   demographic: 22\n *                   behavioral: 28\n *                   engagement: 20\n *                   company_fit: 20\n *                 metadata:\n *                   sheet_row: 15\n *                   calculation_timestamp: \"2024-06-29T17:45:00.000Z\"\n *             medium_score_lead:\n *               summary: Lead con score medio\n *               value:\n *                 contact_id: \"98765432109\"\n *                 email: \"maria.garcia@startup.com\"\n *                 score: 65\n *                 source: \"google_sheets_automation\"\n *                 scoring_factors:\n *                   demographic: 15\n *                   behavioral: 20\n *                   engagement: 15\n *                   company_fit: 15\n *                 metadata:\n *                   sheet_row: 23\n *                   calculation_timestamp: \"2024-06-29T17:47:00.000Z\"\n *     responses:\n *       200:\n *         description: Webhook procesado exitosamente\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 success:\n *                   type: boolean\n *                 contact_id:\n *                   type: string\n *                 score_updated:\n *                   type: boolean\n *                 previous_score:\n *                   type: integer\n *                 new_score:\n *                   type: integer\n *                 notifications_sent:\n *                   type: object\n *                   properties:\n *                     slack:\n *                       type: boolean\n *                       description: Si se envió notificación a Slack\n *                     hubspot:\n *                       type: boolean\n *                       description: Si se actualizó en HubSpot\n *                 automations_triggered:\n *                   type: array\n *                   items:\n *                     type: string\n *                   description: Automatizaciones adicionales disparadas\n *                 processed_at:\n *                   type: string\n *                   format: date-time\n *             example:\n *               success: true\n *               contact_id: \"12345678901\"\n *               score_updated: true\n *               previous_score: 45\n *               new_score: 90\n *               notifications_sent:\n *                 slack: true\n *                 hubspot: true\n *               automations_triggered:\n *                 - \"assign_to_sales_rep\"\n *                 - \"update_lifecycle_stage\"\n *                 - \"create_task_for_followup\"\n *               processed_at: \"2024-06-29T18:00:00.000Z\"\n *       400:\n *         $ref: '#/components/responses/BadRequest'\n *       401:\n *         $ref: '#/components/responses/Unauthorized'\n *       404:\n *         description: Contacto no encontrado\n *         content:\n *           application/json:\n *             schema:\n *               $ref: '#/components/schemas/Error'\n *             example:\n *               error: \"CONTACT_NOT_FOUND\"\n *               message: \"No se encontró contacto con el ID proporcionado\"\n *               contact_id: \"12345678901\"\n *       500:\n *         $ref: '#/components/responses/InternalError'\n */\nrouter.post(\n  '/webhook/lead-scoring',\n  async (req: Request, res: Response): Promise<void> => {\n    try {\n      const { contact_id, email, score, source, scoring_factors, metadata } =\n        req.body;\n\n      // Validación básica\n      if (!contact_id && !email) {\n        res.status(400).json({\n          error: 'MISSING_CONTACT_IDENTIFIER',\n          message:\n            'Se requiere contact_id o email para identificar el contacto',\n        });\n        return;\n      }\n\n      if (typeof score !== 'number' || score < 0 || score > 100) {\n        res.status(400).json({\n          error: 'INVALID_SCORE',\n          message: 'El score debe ser un número entre 0 y 100',\n        });\n        return;\n      }\n\n      if (!source) {\n        res.status(400).json({\n          error: 'MISSING_SOURCE',\n          message: 'El campo source es obligatorio',\n        });\n        return;\n      }\n\n      // Mock processing - En producción aquí iría la lógica real\n      const previousScore = Math.floor(Math.random() * 100);\n      const shouldNotifySlack = score > 70;\n\n      const automationsTriggered = [];\n      if (score > 75) automationsTriggered.push('assign_to_sales_rep');\n      if (score > 80) automationsTriggered.push('update_lifecycle_stage');\n      if (score > 85) automationsTriggered.push('create_task_for_followup');\n\n      const response = {\n        success: true,\n        contact_id: contact_id || `resolved_from_email_${Date.now()}`,\n        score_updated: true,\n        previous_score: previousScore,\n        new_score: score,\n        scoring_factors,\n        source,\n        notifications_sent: {\n          slack: shouldNotifySlack,\n          hubspot: true,\n        },\n        automations_triggered: automationsTriggered,\n        metadata: {\n          ...metadata,\n          processing_duration_ms: Math.floor(Math.random() * 500) + 100,\n          zapier_webhook_id: `zwh_${Date.now()}`,\n        },\n        processed_at: new Date().toISOString(),\n      };\n\n      res.json(response);\n    } catch (error) {\n      res.status(500).json({\n        error: 'LEAD_SCORING_WEBHOOK_FAILED',\n        message: error instanceof Error ? error.message : 'Error desconocido',\n        timestamp: new Date().toISOString(),\n      });\n    }\n  }\n);\n\n/**\n * @swagger\n * /zapier/webhook/form-submission:\n *   post:\n *     tags: [Zapier]\n *     summary: Webhook para nuevas submissions de formularios\n *     description: |\n *       Recibe webhooks cuando se envía un formulario web y procesa automáticamente el lead.\n *\n *       **Procesamiento automático:**\n *       1. 📝 Validación de datos del formulario\n *       2. 🔍 Verificación de duplicados en HubSpot\n *       3. 📊 Cálculo inicial de lead score\n *       4. 💾 Creación/actualización de contacto en HubSpot\n *       5. 🔔 Notificación inmediata a Slack\n *       6. 📈 Actualización en Google Sheets para tracking\n *\n *       **Enriquecimiento automático:**\n *       - 🌐 Lookup de información de empresa\n *       - 📍 Geolocalización por IP\n *       - 🏷️ Clasificación automática de lead\n *       - 📊 Score inicial basado en fuente y datos\n *     security:\n *       - apiKeyAuth: []\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required: [email, form_name, submitted_at]\n *             properties:\n *               email:\n *                 type: string\n *                 format: email\n *                 description: Email del lead\n *                 example: \"nuevo.lead@empresa.com\"\n *               firstname:\n *                 type: string\n *                 description: Nombre del lead\n *                 example: \"Carlos\"\n *               lastname:\n *                 type: string\n *                 description: Apellido del lead\n *                 example: \"Ruiz\"\n *               phone:\n *                 type: string\n *                 description: Teléfono del lead\n *                 example: \"+34 666 777 888\"\n *               company:\n *                 type: string\n *                 description: Empresa del lead\n *                 example: \"Innovative Solutions SL\"\n *               form_name:\n *                 type: string\n *                 description: Nombre del formulario enviado\n *                 example: \"Contact Form - Homepage\"\n *               form_data:\n *                 type: object\n *                 description: Datos adicionales del formulario\n *                 additionalProperties: true\n *               submitted_at:\n *                 type: string\n *                 format: date-time\n *                 description: Timestamp de envío del formulario\n *               page_url:\n *                 type: string\n *                 description: URL donde se envió el formulario\n *                 example: \"https://kopp-stadium.com/contact\"\n *               user_ip:\n *                 type: string\n *                 description: IP del usuario para geolocalización\n *                 example: \"192.168.1.1\"\n *               utm_parameters:\n *                 type: object\n *                 description: Parámetros UTM para tracking\n *                 properties:\n *                   utm_source: { type: string }\n *                   utm_medium: { type: string }\n *                   utm_campaign: { type: string }\n *                   utm_term: { type: string }\n *                   utm_content: { type: string }\n *           examples:\n *             contact_form:\n *               summary: Formulario de contacto básico\n *               value:\n *                 email: \"carlos.ruiz@innovative.com\"\n *                 firstname: \"Carlos\"\n *                 lastname: \"Ruiz\"\n *                 phone: \"+34 666 777 888\"\n *                 company: \"Innovative Solutions SL\"\n *                 form_name: \"Contact Form - Homepage\"\n *                 form_data:\n *                   message: \"Interesado en sus servicios de CRM\"\n *                   budget: \"10000-50000\"\n *                   timeline: \"3-6 months\"\n *                 submitted_at: \"2024-06-29T18:00:00.000Z\"\n *                 page_url: \"https://kopp-stadium.com/contact\"\n *                 user_ip: \"185.76.8.165\"\n *                 utm_parameters:\n *                   utm_source: \"google\"\n *                   utm_medium: \"cpc\"\n *                   utm_campaign: \"crm-solutions\"\n *             demo_request:\n *               summary: Solicitud de demo\n *               value:\n *                 email: \"director@bigcorp.com\"\n *                 firstname: \"Ana\"\n *                 lastname: \"Martínez\"\n *                 phone: \"+34 910 123 456\"\n *                 company: \"BigCorp Enterprise\"\n *                 form_name: \"Demo Request Form\"\n *                 form_data:\n *                   job_title: \"IT Director\"\n *                   company_size: \"501-1000\"\n *                   use_case: \"Sales automation\"\n *                   preferred_date: \"2024-07-05\"\n *                 submitted_at: \"2024-06-29T17:30:00.000Z\"\n *                 page_url: \"https://kopp-stadium.com/demo\"\n *     responses:\n *       200:\n *         description: Formulario procesado exitosamente\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 success:\n *                   type: boolean\n *                 lead_id:\n *                   type: string\n *                   description: ID del lead creado/actualizado\n *                 contact_id:\n *                   type: string\n *                   description: ID del contacto en HubSpot\n *                 is_new_contact:\n *                   type: boolean\n *                   description: Si es un contacto nuevo o actualización\n *                 initial_score:\n *                   type: integer\n *                   description: Score inicial calculado\n *                 enrichment_data:\n *                   type: object\n *                   description: Datos adicionales obtenidos automáticamente\n *                   properties:\n *                     company_info:\n *                       type: object\n *                       description: Información de empresa enriquecida\n *                     geolocation:\n *                       type: object\n *                       description: Datos de geolocalización\n *                 notifications_sent:\n *                   type: object\n *                   properties:\n *                     slack_channel:\n *                       type: string\n *                       description: Canal de Slack notificado\n *                     email_confirmation:\n *                       type: boolean\n *                       description: Si se envió email de confirmación\n *                 next_steps:\n *                   type: array\n *                   items:\n *                     type: string\n *                   description: Próximos pasos automatizados programados\n *                 processed_at:\n *                   type: string\n *                   format: date-time\n *             example:\n *               success: true\n *               lead_id: \"lead_29062024_001\"\n *               contact_id: \"55667788990\"\n *               is_new_contact: true\n *               initial_score: 75\n *               enrichment_data:\n *                 company_info:\n *                   domain: \"innovative.com\"\n *                   industry: \"Technology\"\n *                   employee_count: \"51-200\"\n *                 geolocation:\n *                   country: \"Spain\"\n *                   city: \"Madrid\"\n *                   timezone: \"Europe/Madrid\"\n *               notifications_sent:\n *                 slack_channel: \"#leads\"\n *                 email_confirmation: true\n *               next_steps:\n *                 - \"Send welcome email sequence\"\n *                 - \"Schedule follow-up task for sales rep\"\n *                 - \"Add to nurturing campaign\"\n *               processed_at: \"2024-06-29T18:00:00.000Z\"\n *       400:\n *         $ref: '#/components/responses/BadRequest'\n *       401:\n *         $ref: '#/components/responses/Unauthorized'\n *       429:\n *         $ref: '#/components/responses/TooManyRequests'\n *       500:\n *         $ref: '#/components/responses/InternalError'\n */\nrouter.post(\n  '/webhook/form-submission',\n  async (req: Request, res: Response): Promise<void> => {\n    try {\n      const {\n        email,\n        firstname,\n        lastname,\n        phone,\n        company,\n        form_name,\n        form_data,\n        submitted_at,\n        page_url,\n        user_ip,\n        utm_parameters,\n      } = req.body;\n\n      // Validación básica\n      if (!email) {\n        res.status(400).json({\n          error: 'MISSING_EMAIL',\n          message: 'El campo email es obligatorio',\n        });\n        return;\n      }\n\n      if (!form_name) {\n        res.status(400).json({\n          error: 'MISSING_FORM_NAME',\n          message: 'El campo form_name es obligatorio',\n        });\n        return;\n      }\n\n      if (!submitted_at) {\n        res.status(400).json({\n          error: 'MISSING_SUBMITTED_AT',\n          message: 'El campo submitted_at es obligatorio',\n        });\n        return;\n      }\n\n      // Mock processing - En producción aquí iría la lógica real\n      const leadId = `lead_${new Date().toISOString().split('T')[0].replace(/-/g, '')}_${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`;\n      const contactId = `${Date.now()}${Math.floor(Math.random() * 1000)}`;\n      const initialScore = Math.floor(Math.random() * 40) + 40; // Score entre 40-80 para nuevos leads\n\n      const response = {\n        success: true,\n        lead_id: leadId,\n        contact_id: contactId,\n        is_new_contact: true,\n        initial_score: initialScore,\n        form_details: {\n          name: form_name,\n          page_url,\n          submitted_at,\n        },\n        contact_data: {\n          email,\n          firstname,\n          lastname,\n          phone,\n          company,\n        },\n        enrichment_data: {\n          company_info: company\n            ? {\n                domain: company.toLowerCase().replace(/\\s+/g, '') + '.com',\n                industry: 'Technology',\n                employee_count: '51-200',\n              }\n            : null,\n          geolocation: user_ip\n            ? {\n                country: 'Spain',\n                city: 'Madrid',\n                timezone: 'Europe/Madrid',\n              }\n            : null,\n          utm_tracking: utm_parameters,\n        },\n        notifications_sent: {\n          slack_channel: '#leads',\n          email_confirmation: true,\n        },\n        next_steps: [\n          'Send welcome email sequence',\n          'Schedule follow-up task for sales rep',\n          'Add to nurturing campaign',\n        ],\n        form_data,\n        processed_at: new Date().toISOString(),\n      };\n\n      res.json(response);\n    } catch (error) {\n      res.status(500).json({\n        error: 'FORM_SUBMISSION_WEBHOOK_FAILED',\n        message: error instanceof Error ? error.message : 'Error desconocido',\n        timestamp: new Date().toISOString(),\n      });\n    }\n  }\n);\n\n/**\n * @swagger\n * /zapier/status:\n *   get:\n *     tags: [Zapier]\n *     summary: Estado de integración con Zapier\n *     description: |\n *       Obtiene el estado actual de la integración con Zapier, incluyendo:\n *\n *       **Información de estado:**\n *       - ✅ Conectividad con Zapier webhooks\n *       - 📊 Estadísticas de webhooks recibidos\n *       - ⚡ Zaps activos y configurados\n *       - 🕒 Últimas actividades y timestamps\n *       - 🚨 Errores recientes y rate limits\n *\n *       **Métricas incluidas:**\n *       - 📈 Webhooks procesados (últimas 24h, 7 días, 30 días)\n *       - ⏱️ Tiempo promedio de procesamiento\n *       - 📊 Distribución por tipo de evento\n *       - 🔄 Estado de automatizaciones activas\n *     security:\n *       - apiKeyAuth: []\n *     responses:\n *       200:\n *         description: Estado de Zapier obtenido exitosamente\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 success:\n *                   type: boolean\n *                 zapier_integration:\n *                   type: object\n *                   properties:\n *                     status:\n *                       type: string\n *                       enum: [active, inactive, error]\n *                       description: Estado general de la integración\n *                     active_zaps:\n *                       type: integer\n *                       description: Número de Zaps activos relacionados\n *                     webhook_endpoints:\n *                       type: array\n *                       items:\n *                         type: object\n *                         properties:\n *                           endpoint: { type: string }\n *                           status: { type: string }\n *                           last_activity: { type: string }\n *                 webhook_stats:\n *                   type: object\n *                   properties:\n *                     last_24h:\n *                       type: object\n *                       properties:\n *                         total_received: { type: integer }\n *                         successful: { type: integer }\n *                         failed: { type: integer }\n *                     last_7d:\n *                       type: object\n *                       properties:\n *                         total_received: { type: integer }\n *                         successful: { type: integer }\n *                         failed: { type: integer }\n *                     avg_processing_time_ms:\n *                       type: number\n *                       description: Tiempo promedio de procesamiento\n *                 event_distribution:\n *                   type: object\n *                   description: Distribución de eventos por tipo\n *                   additionalProperties:\n *                     type: integer\n *                 recent_activity:\n *                   type: array\n *                   items:\n *                     type: object\n *                     properties:\n *                       timestamp: { type: string }\n *                       event_type: { type: string }\n *                       status: { type: string }\n *                       processing_time_ms: { type: number }\n *                 checked_at:\n *                   type: string\n *                   format: date-time\n *             example:\n *               success: true\n *               zapier_integration:\n *                 status: \"active\"\n *                 active_zaps: 8\n *                 webhook_endpoints:\n *                   - endpoint: \"/zapier/webhook/lead-scoring\"\n *                     status: \"active\"\n *                     last_activity: \"2024-06-29T17:45:00.000Z\"\n *                   - endpoint: \"/zapier/webhook/form-submission\"\n *                     status: \"active\"\n *                     last_activity: \"2024-06-29T17:30:00.000Z\"\n *               webhook_stats:\n *                 last_24h:\n *                   total_received: 45\n *                   successful: 43\n *                   failed: 2\n *                 last_7d:\n *                   total_received: 287\n *                   successful: 278\n *                   failed: 9\n *                 avg_processing_time_ms: 245.8\n *               event_distribution:\n *                 lead_scoring: 156\n *                 form_submission: 89\n *                 contact_update: 42\n *               recent_activity:\n *                 - timestamp: \"2024-06-29T17:45:00.000Z\"\n *                   event_type: \"lead_scoring\"\n *                   status: \"success\"\n *                   processing_time_ms: 234\n *                 - timestamp: \"2024-06-29T17:30:00.000Z\"\n *                   event_type: \"form_submission\"\n *                   status: \"success\"\n *                   processing_time_ms: 189\n *               checked_at: \"2024-06-29T18:00:00.000Z\"\n *       401:\n *         $ref: '#/components/responses/Unauthorized'\n *       500:\n *         $ref: '#/components/responses/InternalError'\n */\nrouter.get('/status', async (req: Request, res: Response): Promise<void> => {\n  try {\n    // Mock response - En producción aquí iría la lógica real\n    const response = {\n      success: true,\n      zapier_integration: {\n        status: 'active',\n        active_zaps: 8,\n        webhook_endpoints: [\n          {\n            endpoint: '/zapier/webhook/lead-scoring',\n            status: 'active',\n            last_activity: new Date(Date.now() - 15 * 60 * 1000).toISOString(),\n          },\n          {\n            endpoint: '/zapier/webhook/form-submission',\n            status: 'active',\n            last_activity: new Date(Date.now() - 30 * 60 * 1000).toISOString(),\n          },\n        ],\n      },\n      webhook_stats: {\n        last_24h: {\n          total_received: 45,\n          successful: 43,\n          failed: 2,\n        },\n        last_7d: {\n          total_received: 287,\n          successful: 278,\n          failed: 9,\n        },\n        avg_processing_time_ms: 245.8,\n      },\n      event_distribution: {\n        lead_scoring: 156,\n        form_submission: 89,\n        contact_update: 42,\n      },\n      recent_activity: [\n        {\n          timestamp: new Date(Date.now() - 15 * 60 * 1000).toISOString(),\n          event_type: 'lead_scoring',\n          status: 'success',\n          processing_time_ms: 234,\n        },\n        {\n          timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString(),\n          event_type: 'form_submission',\n          status: 'success',\n          processing_time_ms: 189,\n        },\n      ],\n      checked_at: new Date().toISOString(),\n    };\n\n    res.json(response);\n  } catch (error) {\n    res.status(500).json({\n      error: 'ZAPIER_STATUS_CHECK_FAILED',\n      message: error instanceof Error ? error.message : 'Error desconocido',\n      timestamp: new Date().toISOString(),\n    });\n  }\n});\n\nexport default router;\n"],"version":3}